name: OCR and Generate Script

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '40 8 * * *' 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 允许写入内容（用于提交和发布）

    steps:
    # 1. 检出代码
    - uses: actions/checkout@v3

    # 2. 设置 Python 环境
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    # 3. 安装其他 Python 依赖
    - name: Install other Python dependencies
      run: |
        pip install -r requirements.txt

    # 4. 运行 OCR 脚本
    - name: Run OCR script
      env:
        TZ: Asia/Shanghai
      run: |
        python ocr.py

    # 5. 提交并推送 getsid.bat 文件
    - name: Commit and push getsid.bat
      id: commit_step  # 标记步骤ID用于后续判断
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        if [[ $(git status --porcelain | grep "getsid.bat") ]]; then
          echo "Changes detected in getsid.bat, committing..."
          git add getsid.bat
          git commit -m "Automate update of getsid.bat using PaddleOCR"
          git push
          echo "commit_pushed=true" >> $GITHUB_OUTPUT  # 设置输出变量标记提交成功
        else
          echo "No changes to commit for getsid.bat."
          echo "commit_pushed=false" >> $GITHUB_OUTPUT
        fi

    # 6. 检查是否有新提交（用于决定是否发布）
    - name: Check if new commit was pushed
      id: check_commit
      run: |
        echo "Commit pushed status: ${{ steps.commit_step.outputs.commit_pushed }}"

    # 7. 创建Release（仅当有新提交时）
    - name: Create Release
      if: steps.commit_step.outputs.commit_pushed == 'true'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}-$(date +%Y%m%d)  # 版本号格式：v运行次数-日期
        release_name: getsid.bat Update v${{ github.run_number }}  # Release名称
        body: |
          自动更新的getsid.bat文件
          生成时间: $(date +%Y-%m-%d %H:%M:%S)
        draft: false  # 非草稿
        prerelease: false  # 非预发布

    # 8. 上传getsid.bat到Release（仅当有新提交时）
    - name: Upload Release Asset
      if: steps.commit_step.outputs.commit_pushed == 'true'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}  # 从创建Release步骤获取上传URL
        asset_path: ./getsid.bat  # 本地文件路径
        asset_name: getsid.bat  # 上传后的文件名
        asset_content_type: application/octet-stream  # 文件类型（二进制）
